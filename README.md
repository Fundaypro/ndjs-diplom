# Дипломный проект: Сайт-агрегатор объявлений гостиниц + бронирование

## Описание проекта

Необходимо разработать сайт-агрегатор объявлений гостиниц. Также должно быть реализовано бронирование гостиницы на диапазон дат

## Цель

Разработка публичного апи, разработка апи пользователя, разработка апи администратора, разработка чата консультанта

## Технологический стек

- Node.js
- Nest.js
- MongoDB
- Websocket

## Допущения

Оплату бронирования реализовывать не нужно

## 1. Описание базовых модулей

Базовые модули служат для описания бизнес-логики и хранения данных.

### 1.1 Модуль "Пользователи"

Модуль пользователи предназначается для создания, хранения и поиска профилей пользователей.

Модуль пользователи используется функциональными модулями для регистрации и аутентификации.

Данные пользователя должны храниться в MongoDB.

Модель данных `User` пользователя должна содержать следующие поля:

| название     |    тип     | обязательное | уникальное | по умолчанию |
| ------------ | :--------: | :----------: | :--------: | :----------: |
| \_id         | `ObjectId` |      да      |     да     |              |
| email        |  `string`  |      да      |     да     |              |
| passwordHash |  `string`  |      да      |    нет     |              |
| name         |  `string`  |      да      |    нет     |              |
| contactPhone |  `string`  |     нет      |    нет     |              |
| role         |  `string`  |      да      |    нет     |   `client`   |

---

Модуль "Гостиницы" должен быть реализован в виде NestJS модуля и экспортировать сервисы со следующими интерфейсами

```ts
interface IUserService {
  create(data: Partial<User>): Promise<User>;
  findById(id: ObjectId): Promise<User>;
  findByEmail(email: string): Promise<User>;
}
```

### 1.2 Модуль "Гостиницы"

Модуль "Гостиницы" предназначается для хранения и поиска гостиниц и комнат.

Модуль "Гостиницы" используется функциональными модулями для показа списка мест для бронирования, а так же для их добавления, включения и выключения.

Данные должны храниться в MongoDb.

Модель данных `Hotel` должна содержать следующие поля:

| название    |    тип     | обязательное | уникальное | по умолчанию |
| ----------- | :--------: | :----------: | :--------: | :----------: |
| \_id        | `ObjectId` |      да      |     да     |              |
| title       | `ObjectId` |      да      |    нет     |              |
| description |  `string`  |     нет      |    нет     |              |
| tags        | `string[]` |     нет      |    нет     |     `[]`     |
| createdAt   |   `Date`   |      да      |    нет     |              |
| updatedAt   |   `Date`   |      да      |    нет     |              |

Модель данных `HotelRoom` должна содержать следующие поля:

| название    |    тип     | обязательное | уникальное | по умолчанию |
| ----------- | :--------: | :----------: | :--------: | :----------: |
| \_id        | `ObjectId` |      да      |     да     |              |
| hotel       | `ObjectId` |      да      |    нет     |              |
| description |  `string`  |     нет      |    нет     |              |
| images      | `string[]` |     нет      |    нет     |     `[]`     |
| createdAt   |   `Date`   |      да      |    нет     |              |
| updatedAt   |   `Date`   |      да      |    нет     |              |
| tags        | `string[]` |     нет      |    нет     |     `[]`     |
| isEnabled   | `boolean`  |      да      |    нет     |    `true`    |

Свойство `hotel` должно [ссылаться](https://mongoosejs.com/docs/populate.html) на модель `Hotel`

---

Модуль "Гостиницы" должен быть реализован в виде NestJS модуля и экспортировать сервисы со следующими интерфейсами

```ts
interface IHotelService {
  create(data: any): Promise<Hotel>;
  findById(id: string | ObjectId): Promise<Hotel>;
  search(params: Pick<Hotel, "title" | "tags">): Promise<Hotel[]>;
}

interface HotelRoomService {
  create(data: Partial<HotelRoom>): Promise<HotelRoom>;
  findById(id: string | ObjectId): Promise<HotelRoom>;
  search(
    params: Pick<HotelRoom, "title" | "tags" | "isEnabled">
  ): Promise<HotelRoom[]>;

  update(id: string | ObjectId, data: Partial<HotelRoom>): Promise<HotelRoom>;
}
```

### 1.3 Модуль Избранное

Модуль избранное предназначен для хранения и получения избранных гостиниц конкретного пользователя.

Модуль избранное **не должен** использовать Модуль Пользователи и Модуль Гостиницы для получения данных

Модуль избранное **не должен хранить** данные пользователей и гостиниц

Модуль избранное **должен** использовать соединение с базой данных

Данные должны храниться в MongoDb.

Модель данных `Favorites` должна содержать следующие поля:

| название |    тип     | обязательное | уникальное | по умолчанию |
| -------- | :--------: | :----------: | :--------: | :----------: |
| \_id     | `ObjectId` |      да      |     да     |              |
| userId   | `ObjectId` |      да      |    нет     |              |
| hotelId  | `ObjectId` |      да      |    нет     |              |

---

Модуль "Избранное" должен быть реализован в виде NestJS модуля и экспортировать сервисы со следующими интерфейсами

```ts
interface IFavorites {
  addFavorites(user: ObjectId, hotel: ObjectId): Promise<void>;
  removeFavorites(user: ObjectId, hotel: ObjectId): Promise<void>;
  getFavorites(user: ObjectId): Promise<ObjectId[]>;
}
```

При реализации необходимо учесть:

- если при добавлении гостиница уже в избранном, то ничего делать не нужно
- если при удалении гостиницы нет в избранном, то ничего делать не нужно

### 1.4 Модуль Брони

Модуль брони предназначен для хранения и получения броней гостиниц конкретного пользователя.

Модуль брони **не должен** использовать Модуль Пользователи и Модуль Гостиницы для получения данных

Модуль брони **не должен** хранить данные пользователей и гостиниц

Модуль брони **должен** использовать соединение с базой данных

Данные должны храниться в MongoDb.

Модель данных `Reservation` должна содержать следующие поля:

| название |    тип     | обязательное | уникальное | по умолчанию |
| -------- | :--------: | :----------: | :--------: | :----------: |
| \_id     | `ObjectId` |      да      |     да     |              |
| userId   | `ObjectId` |      да      |    нет     |              |
| hotelId  | `ObjectId` |      да      |    нет     |              |
| roomId   | `ObjectId` |      да      |    нет     |              |
| date     |   `Date`   |      да      |    нет     |              |

<!-- Подумать про диапазон дат -->

---

Модуль "Брони" должен быть реализован в виде NestJS модуля и экспортировать сервисы со следующими интерфейсами

```ts
interface ReservationDto {
  user: ObjectId;
  hotel: ObjectId;
  room: ObjectId;
  date: Date;
}
interface IReservation {
  addReservation(data: ReservationDto): Promise<Reservation>;
  removeReservation(data: ReservationDto): Promise<void>;
  getReservations(
    filter: Pick<ResercationDto, "user" | "date">
  ): Promise<Array<Pick<ResercationDto, "hotel" | "room">>>;
}
```

### 1.5 Модуль "Чат"

Модуль "Чат" предназначается для хранения чатов и сообщений в чате.

Модуль объявлений используется функциональными модулями для реализации возможности общения пользователей.

Данные чатов должны храниться в MongoDB.

Модель данных чата `Chat` должна содержать следующие поля:

| название  |           тип            | обязательное | уникальное |
| --------- | :----------------------: | :----------: | :--------: |
| \_id      |        `ObjectId`        |      да      |     да     |
| users     | [`ObjectId`, `ObjectId`] |      да      |    нет     |
| createdAt |          `Date`          |      да      |    нет     |
| messages  |       `Message[]`        |     нет      |    нет     |

Модель сообщения `Message` должна содержать следующие поля:

| название |    тип     | обязательное | уникальное |
| -------- | :--------: | :----------: | :--------: |
| \_id     | `ObjectId` |      да      |     да     |
| author   | `ObjectId` |      да      |    нет     |
| sentAt   |   `Date`   |      да      |    нет     |
| text     |  `string`  |      да      |    нет     |
| readAt   |   `Date`   |     нет      |    нет     |

Сообщение считается прочитанным когда поле `readAt` не пустое

---

Модуль "Чат" должен быть реализован в виде NestJS модуля и экспортировать сервисы со следующими интерфейсами

```ts
interface SendMessageDto {
  author: ObjectId;
  receiver: ObjectId;
  text: string;
}

interface IChat {
  findChat(users: [ObjectId, Objectid]): Promise<Chat | null>;
  sendMessage(data: SendMessageDto): Promise<Message>;
  getHistory(chatId: ObejctId): Promise<Message[]>;
  subscribe(handler: (chat: Chat, message: Message) => void): () => void;
}
```

---

1. При отправке сообщения нужно

   1. Найти чат между `author` и `receiver` по полю `Chat.users`. Если чата нет, то создать
   1. Добавить в поле `Chat.messages` новое сообщение `Message`. Поле `sentAt` должно соответствовать текущей дате

1. Оповещения в должны быть реализованы через механизм `EventEmitter`

<!-- @TODO отсюда и дальше -->

## 2.Публичное API

Публичное API предназначено для получения информации без аутентификации. Публичное API проекта должно включать

- получение списка доступных активных гостиниц
- получение детальной информации по конкретной гостинице

Публичное API должно использовать Модуль "Гостиницы"

### 2.1 Аутентификация и авторизация

Модуль "Аутентификация и авторизация" предназначен

- для управления сессией пользователя

Хранение сессии должно реализовываться посредством библиотеки passportjs с хранением сессии в памяти приложения

Аутентификация пользователя производится с помощью модуля "Пользователи". Каждому пользователю назначается одна из ролей - клиент, администратор, консультант

HTTP API модуля "Аутентификация и авторизация" должно включать следующие точки доступа

- вход - создание сессии пользователя, установка cookies
- выход - завершение сессии пользователя
- регистрация - создание пользователя с ролью клиент

Помимо HTTP API нужно разработать функции проверки сессии пользователя для доступа к приватным ресурсам
API аутентификации должен использовать Модуль Аутентификация

## 3. API "Пользователя"

API пользователя предназначено для получения информации привязанной к конкретному пользователю
API пользователя доступно только пользователям с ролью клиент

API пользователя должно включать:

- добавление гостиницы в избранные
- получение списка списка ID гостиниц добавленных в избранное
- удаление гостиницы из избранного
- бронирование гостиницы на конкретную дату (один день)
- отмену брони
- просмотр списка своих будущих броней
- чат с консультантом (требование: обмен с сообщениями производится через websocket)

API пользователя должен использовать Модуль Гостиницы, Модуль Избранное, Модуль Брони, Модуль Чат

## 4. API администратора

API администратора предназначено для управлением контентом
API администратора доступно только пользователям с ролью администратор

API администратора должно включать:

- Получение списка всех гостиниц, включая неактивные
- Добавление гостинцы
- Изменение описания гостиницы
- Получение данных о гостинице
- Изменение статуса публикации гостиницы
- Добавление и изменение описания также должно включать загрузку файлов изображений

API администратора должен использовать Модуль Гостиницы

## 5. API консультанта

API консультанта предназначено для работы с клиентами
API консультанта доступно только пользователям с ролью консультант

API консультанта должно включать:

- Просмотр списка всех пользователей
- Просмотр списка будущих броней всех пользователей
- Просмотр списка будущих броней конкретного пользователя
- Просмотр списка чатов (допущение: любой консультант может ответить в любом чате)
- Чат с пользователем (требование: обмен с сообщениями производится через websocket)

API консультанта должен использовать Модуль Пользователи, Модуль Чат, Модуль Брони, Модуль Гостиницы
